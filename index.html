<!DOCTYPE html>
<html>
<head>
	<title>US Wildfires</title>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="https://d3js.org/d3-time.v1.min.js"></script>
	<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
	<script src="d3.legend.js"></script>
	<script src="http://public.tableau.com/javascripts/api/tableau-2.0.0.min.js"></script>

	<style type="text/css">
	.feature {
		fill: none;
		stroke: grey;
		stroke-width: 1px;
		stroke-linejoin: round;
	}
	.mesh {
		fill: none;
		stroke: darkgrey;
		stroke-width: 2px;
		stroke-linejoin: round;
	}
	h1 {
		font-family: sans-serif;
	}
	.sliderDiv {
		width: 950px;
		height: 25px;
	}
	.slider {
		width: 900px !important;
	}
	text {
		font-family: sans-serif;
	}
	.chartTitle {
		font-size:18px;
	}
	.xaxis path,
	.yaxis path {
		fill: #777;
		stroke-opacity: 0.5;
	}

	.legend rect {
	  fill:white;
	  stroke:black;
	  opacity:0.8;
	}

	#tooltip {
		position: absolute;
		width: 200;
		height: auto;
		padding: 10px;
		background-color: white;
		-webkit-border-radius: 10px;
		-mox-border-radius: 10px;
		border-radius: 10px;
		-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
		-mox-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
		box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
		pointer-events: none;
		/* white-space: pre-line; */
		word-wrap: break-word;
	}

	#tooltip.hidden {
		display: none;
	}

	#tooltip p{
		margin: 0;
		font-family: sans-serif;
		font-size: 16px;
		line-height: 20px;
	}

	#layout_main {
  		display: flex;
	}



	</style>
</head>
<body>
	<h1 id="title">US Wildfires</h1>
	<div id="layout_main">
		<div id="layout_left">
			<div class="mainMap"></div>
			<div class="sliderDiv"></div>
			<div id="viz_bottom"></div>
		</div>
		<div id="layout_right">
			<div id="viz_right"></div>
		</div>

	<div id="tooltip" class="hidden">
		<p><strong>Key Info</strong></p>
		<p><span id="value"></span></p>
		<p><span id="latitude"></span></p>
		<p><span id="longitude"></span></p>
	</div>

	<!--<div class="legend"></div>-->

	<script>
		var url_bottom  = 'https://public.tableau.com/shared/PQZNZF643?:showVizHome=no&:toolbar=no&:display_count=no';
		var url_right = 'https://public.tableau.com/views/FiresandWeatherinUnitedStates1997-2005/RightPane?:showVizHome=no&:toolbar=no&:display_count=no';
		
		var vizOptions_bottom = {
			showTabs           : false,
			hideToolbar        : true,
			width              : "950px",
			height             : "500px"
		};

		var vizOptions_right = {
			showTabs           : false,
			hideToolbar        : true,
			width              : "1100px",
			height             : "1100px"
		};
		
		currentViz_bottom = new tableauSoftware.Viz(document.getElementById('viz_bottom'), url_bottom, vizOptions_bottom);
		currentViz_right = new tableauSoftware.Viz(document.getElementById('viz_right'), url_right, vizOptions_right);
      
	</script>

	<script type="text/javascript">

	var map_width = 950,
		map_height = 550;

	// Maps fire class to a radius size
	var firesize_class_radius = { "A": 3,
								  "B": 5,
								  "C": 7,
								  "D": 9,
								  "E": 11,
								  "F": 13,
								  "G": 15 };

	// Define possible fire causes (to use for colors)
	var fire_causes_color_map = { "Debris Burning": "#FFBB78",
					              "Miscellaneous": "#FF9896",
					              "Arson": "#1F77B4",
					              "Lightning": "#D62728",
					              "Missing/Undefined": "#9467BD",
					              "Equipment Use": "#2CA02C",
					              "Campfire": "#AEC7E8",
					              "Children": "#FF7F0E",
					              "Smoking": "#C49C94",
					              "Railroad": "#8C564B",
					              "Powerline": "#C5B0D5",
					              "Fireworks": "#98DF8A",
					              "Structure": "#E377C2"};

	// set projection
	var projection = d3.geo.albers();

	// create path variable
	var path = d3.geo.path().projection(projection);

	var curr_zoom_translate = [-3.623460483197732, -8.708676481227371];
	var curr_zoom_scale = 1.0;
	var curr_year = 1997;

	d3.json("data/us.json", function(error, topo) {
		d3.csv("data/wildfires_10k_sample.csv", function(error, data) {
			d3.csv("data/weather/combined/long/all_years_long.csv", function(error, weather_data) {
				console.log(data);
				console.log(weather_data);

				// build id --> latitude/latittude map
				var lat_long_year_map = {};
				for (var i = 0; i < data.length; i++) {
					var d = data[i];
					lat_long_year_map[String(d.OBJECT_ID)] = [d.LATITUDE, d.LONGITUDE, d.FIRE_YEAR];
				}

				// create svg variable
				var svg = d3.select(".mainMap").append("svg")
								.attr("width", map_width)
								.attr("height", map_height);

				var g = svg.append("g");

				// Add slider
				d3.select(".sliderDiv").append("text").text("Year: ");

				var slider =  d3.select(".sliderDiv").append("input")
					.attr("class", "slider")
					.attr("type", "range")
					.attr("id", "yearSlider")
					.attr("min", 1997)
					.attr("max", 2015)
					.on("input", function() {
						curr_year = parseInt(this.value);
						drawPoints(data, weather_data, curr_year);
						lat_long_range = findViewportLatLong(data, lat_long_year_map, curr_zoom_translate, curr_zoom_scale, curr_year);
						updateTitle(curr_year);
						d3.select(".filter_year").attr("value", curr_year);
					})
					.on("mouseup", function() {
						updateTableauViz(curr_year, lat_long_range);
					});

				drawMap(data, topo, path, projection, lat_long_year_map, curr_year);
				drawPoints(data, weather_data, curr_year);
				updateTitle(curr_year);
				updateTableauViz(curr_year, [26.29, 48.97485, -124.1480556, -69.5]);
			});
		});

		var updateTableauViz = function(year, lat_long_range) {
			currentViz_bottom.getWorkbook().changeParameterValueAsync('year', year);
			currentViz_bottom.getWorkbook().changeParameterValueAsync('min_lat', lat_long_range[0]);
			currentViz_bottom.getWorkbook().changeParameterValueAsync('max_lat', lat_long_range[1]);
			currentViz_bottom.getWorkbook().changeParameterValueAsync('min_long', lat_long_range[2]);
			currentViz_bottom.getWorkbook().changeParameterValueAsync('max_long', lat_long_range[3]);
			currentViz_right.getWorkbook().changeParameterValueAsync('year', year);
			currentViz_right.getWorkbook().changeParameterValueAsync('min_lat', lat_long_range[0]);
			currentViz_right.getWorkbook().changeParameterValueAsync('max_lat', lat_long_range[1]);
			currentViz_right.getWorkbook().changeParameterValueAsync('min_long', lat_long_range[2]);
			currentViz_right.getWorkbook().changeParameterValueAsync('max_long', lat_long_range[3]);
		}

		var drawMap = function(data, topo, path, projection, lat_long_year_map, curr_year) {
		  	states = topojson.feature(topo, topo.objects.states).features;

		  	var svg = d3.select(".mainMap").select("svg");

			var g = svg.select("g");

			// add states from topojson
			g.selectAll("path")
				.data(states).enter()
				.append("path")
				.attr("class", "feature")
				.style("fill", "white")
				.attr("d", path);

			// put border around states
			g.append("path")
				.datum(topojson.mesh(topo, topo.objects.states, function(a, b) { return a !== b; }))
				.attr("class", "mesh")
				.attr("d", path);

			// zooming and panning
			var zoom = d3.behavior.zoom()
				.on("zoom",function(){
					curr_zoom_translate = d3.event.translate;
					curr_zoom_scale = d3.event.scale;
					zoomTo(curr_zoom_translate, curr_zoom_scale);					
				})
				.on("zoomend", function(){
					if (curr_zoom_translate != null && curr_zoom_scale != null) {
						lat_long_range = findViewportLatLong(data, lat_long_year_map, curr_zoom_translate, curr_zoom_scale, curr_year);
						updateTableauViz(curr_year, lat_long_range);
					}
				})
			;

			var zoomTo = function(translate, scale) {
				g.attr("transform","translate("+ translate.join(",")+")scale("+scale+")");
			};

			d3.select(".mainMap").select("svg").call(zoom);
		}

		var drawPoints = function(data, weather_data, year) {
			var filtered_data = data.filter(function(d) {
				return d.FIRE_YEAR == year;
			});

			var g = d3.select(".mainMap").select("svg").select("g");
			// var inner = g.append("g")

			// Remove all previously drawn circles
			g.selectAll("circle").remove();
			g.selectAll("g").remove();

			// add circles to svg
			g.selectAll("circle")
				.data(filtered_data)
				.enter()
				.append("circle")
				.attr("id", function (d) { return d.OBJECT_ID; })
				.attr("class", function (d) { return "p" + d.OBJECT_ID; })
				.attr("cx", function (d) { return projection([d.LONGITUDE, d.LATITUDE])[0]; }) 	// Sets location of the wildfire datapoint
				.attr("cy", function (d) { return projection([d.LONGITUDE, d.LATITUDE])[1]; }) 	// Sets location of the wildfire datapoint
				.attr("r", function (d) { return firesize_class_radius[d.FIRE_SIZE_CLASS]; })  	// Sets radius of the wildfire datapoint
				.attr("fill", function(d) { return fire_causes_color_map[d.STAT_CAUSE_DESCR]; })// Sets fill of the wildfire datapoint
				.attr("data-legend", function(d) {return d.STAT_CAUSE_DESCR})
				.on("mouseover",function(d){
					var id = d3.select(this).attr("id");

					// Tooltip on mouseover
					var filtered_data = data.filter(function(d){
						return d.OBJECT_ID == id;
					});

					var lat = filtered_data[0].LATITUDE;
					var long = filtered_data[0].LONGITUDE;

					d3.select("#tooltip")
						.style("left", d3.select(this).attr("cx") + "px")
						.style("top", d3.select(this).attr("cy") + "px")
						.select("#value")
						.html("Fire Name: " + d.FIRE_NAME + "<br/>" + "Year: " + d.FIRE_YEAR + "<br/>" + "Cause: " + d.STAT_CAUSE_DESCR + "<br/>" + "Latitude: " + lat + "<br/>" + "Longitude: " + long);

					d3.select("#tooltip").classed("hidden", false);
				})
				.on("mouseout", function() {
					d3.select("#tooltip").classed("hidden",true);
				});

				/*
				// Create Legend
				var legend = g.append("g")
					.attr("class","legend")
					// .attr("transform","translate(" + map_width - 1 + "," + "50)")
					.attr("transform","translate(20,375)")
					.style("font-size","12px")
					.call(d3.legend)

				setTimeout(function() {
					legend
						.style("font-size","12px")
						.attr("data-style-padding",10)
						.call(d3.legend)
						},1000)
				*/
		}

		// Finds the min and max lat and longs of the data points in the viewport
		var findViewportLatLong = function(data, lat_long_year_map, translate, scale, curr_year) {	
			var min_lat = 1000;
			var max_lat = -1000;
			var min_long = 1000;
			var max_long = -1000;

			var count = 0;

			var cs = d3.selectAll("circle")[0];
			for (var i = 0; i < cs.length; i++) {
				var c = cs[i];

				count++;
				var id = c.attributes.id.value;
				var cx = c.attributes.cx.value;
				var cy = c.attributes.cy.value;
				var transformed_cx = (cx * scale) + translate[0];
				var transformed_cy = (cy * scale) + translate[1];
				var lat = parseFloat(lat_long_year_map[id][0]);
				var long = parseFloat(lat_long_year_map[id][1]);
				var year = lat_long_year_map[id][2];
				
				// Check if circle is in the viewport
				if (transformed_cx > 0 && transformed_cy > 0 && transformed_cx <= map_width && transformed_cy <= map_height && year == curr_year) {
					// Check if the circle is the max or min lat/long so far. If so, update the max/min lat/long
					if (lat < min_lat) { min_lat = lat; }
					if (lat > max_lat) { max_lat = lat; }
					if (long < min_long) { min_long = long; }
					if (long > max_long) { max_long = long; }
					count++;
				}
			}

			if (min_lat == 1000 || max_lat == -1000 || min_long == 1000 || max_long == -1000) {
				min_lat = 0, max_lat = 0, min_long = 0, max_long = 0;
			}

			ret_arr = [ min_lat, max_lat, min_long, max_long ];
			console.log(ret_arr);
			return ret_arr;
		}

		var updateTitle = function(year){
			d3.select("#title").text(function() { return "US Wildfires - " + year;});
		}

	});

	</script>
</body>
</html>
