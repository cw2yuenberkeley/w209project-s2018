<!DOCTYPE html>
<html>
<head>
	<title>US Wildfires</title>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="https://d3js.org/d3-time.v1.min.js"></script>
	<script src="https://d3js.org/d3-time-format.v2.min.js"></script>

	<style type="text/css">
	.feature {
		fill: none;
		stroke: grey;
		stroke-width: 1px;
		stroke-linejoin: round;
	}
	.mesh {
		fill: none;
		stroke: darkgrey;
		stroke-width: 2px;
		stroke-linejoin: round;
	}
	h1 {
		font-family: sans-serif;
	}
	.sliderDiv {
		width: 950px;
		height: 25px;
	}
	.slider {
		width: 900px !important;
	}
	text {
		font-family: sans-serif;
	}
	.chartTitle {
		font-size:18px;
	}
	.xaxis path,
	.yaxis path {
		fill: #777;
		stroke-opacity: 0.5;
	}

	#tooltip {
		position: absolute;
		width: 200;
		height: auto;
		padding: 10px;
		background-color: white;
		-webkit-border-radius: 10px;
		-mox-border-radius: 10px;
		border-radius: 10px;
		-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
		-mox-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
		box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
		pointer-events: none;
		/* white-space: pre-line; */
		word-wrap: break-word;
	}

	#tooltip.hidden {
		display: none;
	}

	#tooltip p{
		margin: 0;
		font-family: sans-serif;
		font-size: 16px;
		line-height: 20px;
	}


	</style>
</head>
<body>
	<h1 id="title">US Wildfires</h1>
	<div class="mainMap"></div><br/>
	<div class="sliderDiv"></div>
	<div class="weatherChart"></div>
	<div class="dataChart"></div>
	<div id="tooltip" class="hidden">
			<p><strong>Key Info</strong></p>
			<p><span id="value">100</span></p>
	<script type="text/javascript">

	var map_width = 950,
		map_height = 550;

	// Maps fire class to a radius size
	var firesize_class_radius = { "A": 3,
								  "B": 5,
								  "C": 7,
								  "D": 9,
								  "E": 11,
								  "F": 13,
								  "G": 15 };

	// Define possible fire causes (to use for colors)
	var fire_causes_color_map = { "Debris Burning": "#e6194b",
					              "Miscellaneous": "#3cb44b",
					              "Arson": "#ffe119",
					              "Lightning": "#0082c8",
					              "Missing/Undefined": "#f58231",
					              "Equipment Use": "#911eb4",
					              "Campfire": "#46f0f0",
					              "Children": "#f032e6",
					              "Smoking": "#d2f53c",
					              "Railroad": "#fabebe",
					              "Powerline": "#008080",
					              "Fireworks": "#e6beff",
					              "Structure": "#aa6e28"};

	// set projection
	var projection = d3.geo.mercator();

	// create path variable
	var path = d3.geo.path().projection(projection);

	// set projection parameters
	projection
		.scale(900)
		.center([-100, 40.5]);

	d3.json("data/us.json", function(error, topo) {
		d3.csv("data/wildfires_10k_sample.csv", function(error, data) {
			d3.csv("data/weather/combined/long/all_years_long.csv", function(error, weather_data) {
				console.log(data);
				console.log(weather_data);

				// create svg variable
				var svg = d3.select(".mainMap").append("svg")
								.attr("width", map_width)
								.attr("height", map_height);

				var g = svg.append("g");

				// Add slider
				d3.select(".sliderDiv").append("text").text("Year: ");

				var slider =  d3.select(".sliderDiv").append("input")
					.attr("class", "slider")
					.attr("type", "range")
					.attr("id", "yearSlider")
					.attr("min", 2000)
					.attr("max", 2015)
					.on("input", function() {
						drawPoints(data, weather_data, parseInt(this.value));
						updateTitle(this.value);
					});

				drawMap(data, topo, path, projection);
				drawPoints(data, weather_data, 2000);
				updateTitle(2000);
			});
		});

		var drawMap = function(data, topo, path, projection) {
		  	states = topojson.feature(topo, topo.objects.states).features;

		  	var svg = d3.select(".mainMap").select("svg");
		  	// var r = svg.append("rect")
		  	// 	.attr("width", map_width)
		  	// 	.attr("height", map_height)
		  	// 	.attr("fill", "lightblue");

			var g = svg.select("g");

			// add states from topojson
			g.selectAll("path")
				.data(states).enter()
				.append("path")
				.attr("class", "feature")
				.style("fill", "white")
				.attr("d", path);

			// put border around states
			g.append("path")
				.datum(topojson.mesh(topo, topo.objects.states, function(a, b) { return a !== b; }))
				.attr("class", "mesh")
				.attr("d", path);

			// zooming and panning
			var zoom = d3.behavior.zoom()
				.on("zoom",function(){
					curr_zoom_translate = d3.event.translate;
					curr_zoom_scale = d3.event.scale;
					zoomTo(curr_zoom_translate, curr_zoom_scale);
					drawDataChart(data, projection);
				});

			var zoomTo = function(translate, scale) {
				g.attr("transform","translate("+ translate.join(",")+")scale("+scale+")");
				g.selectAll("circle").attr("d", path.projection(projection));
				g.selectAll("path").attr("d", path.projection(projection));
			};

			d3.select(".mainMap").select("svg").call(zoom);
			//zoomTo(curr_zoom_translate, curr_zoom_scale);
		}

		var drawPoints = function(data, weather_data, year) {
			var filtered_data = data.filter(function(d) {
				return d.FIRE_YEAR == year;
			});

			var g = d3.select(".mainMap").select("svg").select("g");

			// Remove all previously drawn circles
			g.selectAll("circle").remove();

			// add circles to svg
			g.selectAll("circle")
				.data(filtered_data)
				.enter()
				.append("circle")
				.attr("id", function (d) { return d.OBJECT_ID; })
				.attr("cx", function (d) { return projection([d.LONGITUDE, d.LATITUDE])[0]; }) 	// Sets location of the wildfire datapoint
				.attr("cy", function (d) { return projection([d.LONGITUDE, d.LATITUDE])[1]; }) 	// Sets location of the wildfire datapoint
				.attr("r", function (d) { return firesize_class_radius[d.FIRE_SIZE_CLASS]; })  	// Sets radius of the wildfire datapoint
				.attr("fill", function(d) { return fire_causes_color_map[d.STAT_CAUSE_DESCR]; })// Sets fill of the wildfire datapoint
				.on("mouseover",function(d){
					var id = d3.select(this).attr("id");
					drawWeatherChart(weather_data, id);
					// Tooltip on mouseover
					var xPosition = d3.select(this).attr("cx");
					var yPosition = d3.select(this).attr("cy");
					d3.select("#tooltip")
						.style("left", xPosition + "px")
						.style("top", yPosition + "px")
						.select("#value")
						.html("Fire Name: " + d.FIRE_NAME + "<br/>" + "Year: " + d.FIRE_YEAR + "<br/>" + "Cause: " + d.STAT_CAUSE_DESCR)

					d3.select("#tooltip").classed("hidden", false);
				})
				.on("mouseout", function() {
					d3.select("#tooltip").classed("hidden",true);
				});
		}


		// To do: Gene to draw data chart here
		var drawDataChart = function(data, projection) {
			// Set width and height of the dataChart
			var width_datachart = 100;
			var height_datachart = 100;

			// Filter datsaset to only those that are in the map viewport
			var nw = projection.invert([ 0, 0 ]);
			var se = projection.invert([ map_width, map_height ]);
			var filtered_data = data.filter(function(d){
				// TO DO: double check that this logic correctly filters data in the viewport
				return (d.LATITUDE >= se[0] && d.LATITUDE <= nw[0] && d.LONGITUDE >= nw[1] && d.LONGITUDE <= se[1]);
			});

			// Remove all previously drawn dataChart
			d3.select(".dataChart").remove();

			// Draw dataChart
			var svg = d3.select(".dataChart").append("svg")
				.attr("width", width_datachart)
				.attr("height", height_datachart);

			var g = svg.append("g");
			/*
				Code for drawing chart here using filtered_data as the dataset
			*/
		}

		// To do: Mohammad to draw weather chart here
		var drawWeatherChart = function (weather_data, id) {
			// This is the id of the data point

			var formatDate = d3.timeFormat("%Y-%m-%d");
			var parseDate = d3.timeParse("%Y-%m-%d");

			var filtered_weather_data = weather_data.filter(function(d){
				return d.FIRE_ID == id;
			});

			filtered_weather_data.sort(function(x, y){
   				return d3.ascending(parseDate(x.OBS_DATE), parseDate(y.OBS_DATE));
			})

			console.log(filtered_weather_data);

			// Set width of all chart components
			var width_weatherchart = 950;
			var height_data = 300;
			var height_xaxis = 50;
			var margin_weatherChart = {top: 50, right: 50, bottom: 20, left: 100};

			var width_data = width_weatherchart - margin_weatherChart.right - margin_weatherChart.left;
			var width_xaxis = width_data;

			// Set width and height of the weatherChart
			var width_weatherchart = width_data + margin_weatherChart.left + margin_weatherChart.right;
			var height_weatherchart = height_data + height_xaxis + margin_weatherChart.top + margin_weatherChart.bottom;

			var min_obs_date = d3.min(filtered_weather_data, function(d) { return parseDate(d.OBS_DATE); });
			var max_obs_date = d3.max(filtered_weather_data, function(d) { return parseDate(d.OBS_DATE); });

			var min_prcp = d3.min(filtered_weather_data, function(d) { return d.PRCP; });
			var max_prcp = d3.max(filtered_weather_data, function(d) { return d.PRCP; });

			x_scale_prcp = d3.scale.linear()
			  .domain([min_obs_date, max_obs_date])
			  .range([margin_weatherChart.left, margin_weatherChart.left + width_data]);

			y_scale_prcp = d3.scale.linear()
			  .domain([0, 100]) // 0% to 100% percipitation
			  .range([height_data + margin_weatherChart.top, margin_weatherChart.top]);

			var x_axis_prcp = d3.svg.axis()
				.scale(x_scale_prcp)
				.orient("bottom")
				.ticks(10)
				.tickFormat(formatDate)
				;

			var y_axis_prcp = d3.svg.axis()
				.scale(y_scale_prcp)
				.orient("left")
				.ticks(10)
				;

			// Remove previously drawn weatherChart
			d3.select(".weatherChart").select("svg").remove();

			// Draw weatherChart
			var svg = d3.select(".weatherChart").append("svg")
				.attr("width", width_weatherchart)
				.attr("height", height_weatherchart);

			// Draw x-axis
			svg.append("g")
			  .attr("class", "xaxis")
			  .attr("width", width_xaxis)
			  .attr("height", height_xaxis)
			  .attr("transform", "translate(0," + (margin_weatherChart.top + height_data) + ")")
			  .call(x_axis_prcp);

			// Draw y-axis label
			svg.append("g").append("text")
  				.text("Date")
  				.attr("transform", "translate("+ ((margin_weatherChart.left + width_xaxis)/2) +", " + (margin_weatherChart.top + height_data + 40) +")");

			// Draw y-axis
			svg.append("g")
			  .attr("class", "yaxis")
			  .attr("width", 100)
			  .attr("height", 50)
			  .attr("transform", "translate(" + (margin_weatherChart.left) + ",0)")
			  .call(y_axis_prcp);

			// Draw y-axis label
			svg.append("g").append("text")
  				.text("% Percipitation")
  				.attr("transform", "translate(0, " + (margin_weatherChart.top - 15) +")");

			// Draw chart title
			svg.append("g").append("text")
				.attr("class", "chartTitle")
  				.text("Percent Percipitation During the Incident")
  				.attr("transform", "translate("+ ((margin_weatherChart.left + width_xaxis)/2 - 100) +", " + (margin_weatherChart.top - 20) +")");

			// Draw chart line
			var valueline = d3.svg.line()
				.x(function(d) { return x_scale_prcp(parseDate(d.OBS_DATE)); })
				.y(function(d) { return y_scale_prcp(d.PRCP); })
			;

			var g = svg.append("g");

			// Remove all previously drawn line
			g.selectAll("path").remove();

			// add line to g
			g.append("path")
				.attr("class", "line")
				.attr("d", valueline(filtered_weather_data))
				.attr("fill", "none")
  				.attr("stroke-width", "2")
  				.attr("stroke", "steelblue")
  				;
		}

		var updateTitle = function(year){
			d3.select("#title").text(function() { return "US Wildfires - " + year;});
		}

	});



	</script>
</body>
</html>
